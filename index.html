<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nova ‚Ä¢ Assistant</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --accent:#6ee7b7; --muted:#9aa3b2;
      --bubble-me:#2a2f45; --bubble-nova:#1e2236;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:#e9edf5;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display:flex; flex-direction:column; min-height:100dvh;
    }
    header{
      position:sticky; top:0; z-index:5;
      background:linear-gradient(180deg,rgba(23,26,43,.95),rgba(23,26,43,.85));
      backdrop-filter: blur(8px);
      padding:14px 16px; border-bottom:1px solid #22263d;
      display:flex; align-items:center; gap:10px;
    }
    header h1{font-size:18px; margin:0; letter-spacing:.3px}
    header .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);box-shadow:0 0 10px var(--accent)}
    details.settings{ margin-left:auto; font-size:14px; color:var(--muted); }
    details.settings summary{cursor:pointer; list-style:none}
    details.settings summary::-webkit-details-marker{display:none}
    .settings-box{
      margin-top:10px; background:var(--panel); border:1px solid #232848; border-radius:12px; padding:12px;
      display:grid; gap:8px; min-width:260px;
    }
    .settings-box input{
      width:100%; padding:10px 12px; border:1px solid #2c3153; border-radius:10px; background:#111529; color:#e9edf5;
    }
    .settings-box button{
      padding:9px 12px; border:0; border-radius:10px; background:var(--accent); color:#0b0e1a; font-weight:600; cursor:pointer;
    }

    main{ width:100%; max-width:900px; margin:0 auto; padding:16px; flex:1; display:flex; flex-direction:column; gap:12px; }
    .scroll{ flex:1; overflow:auto; display:flex; flex-direction:column; gap:14px; padding-bottom:8px; }
    .row{display:flex; gap:10px; align-items:flex-end}
    .row.me{justify-content:flex-end}
    .bubble{
      max-width:min(75%, 580px); padding:12px 14px; border-radius:16px;
      line-height:1.45; font-size:15px; white-space:pre-wrap; word-wrap:break-word;
      box-shadow:0 4px 14px rgba(0,0,0,.2); border:1px solid #232848;
    }
    .me .bubble{background:var(--bubble-me)}
    .nova .bubble{background:var(--bubble-nova)}
    .meta{font-size:12px; color:var(--muted); margin-top:4px}
    .avatar{
      width:34px;height:34px;border-radius:50%;flex:0 0 34px; background:#12162a; border:1px solid #232848;
      display:grid; place-items:center; font-weight:700; color:#c7d2fe;
    }
    .typing{display:none; color:var(--muted); font-size:13px; gap:6px; align-items:center}
    .typing.on{display:flex}
    .dots span{display:inline-block;width:6px;height:6px;background:var(--muted);border-radius:999px;margin-right:4px;opacity:.45;animation:b 1.2s infinite}
    .dots span:nth-child(2){animation-delay:.2s}
    .dots span:nth-child(3){animation-delay:.4s}
    @keyframes b{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-4px)}}

    .inputbar{
      position:sticky; bottom:0; background:linear-gradient(0deg, rgba(15,18,32,1), rgba(15,18,32,.9));
      padding:12px 16px; border-top:1px solid #22263d; display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .inputbar input{
      flex:1; min-width:200px; padding:14px 14px; border-radius:12px; border:1px solid #2c3153; background:#111529; color:#e9edf5;
    }
    .btn{
      padding:12px 14px; border:0; border-radius:12px; background:var(--accent); color:#0b0e1a; font-weight:700; cursor:pointer;
    }
    .btn.ghost{ background:#1a1f37; color:#e9edf5; border:1px solid #2c3153 }
    .bar2{ width:100%; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select, input[type="range"]{
      background:#111529; color:#e9edf5; border:1px solid #2c3153; border-radius:10px; padding:8px;
    }
    label{font-size:12px; color:var(--muted)}
    a.link{color:#8ab4ff}
  </style>
</head>
<body>

  <header>
    <div class="dot"></div>
    <h1>Nova ‚Ä¢ Assistant</h1>
    <details class="settings">
      <summary>‚öôÔ∏è R√©glages</summary>
      <div class="settings-box">
        <label>URL du backend (Vercel)</label>
        <input id="apiUrl" placeholder="https://yarrow-ai-server.vercel.app" />
        <button id="saveApi">Enregistrer</button>
        <small>Astuce : laisse vide pour revenir √† la valeur par d√©faut.</small>
      </div>
    </details>
  </header>

  <main>
    <div class="scroll" id="list">
      <div class="row nova">
        <div class="avatar">N</div>
        <div>
          <div class="bubble">Bonjour üëã Je suis Nova. Pose-moi une question !</div>
          <div class="meta" id="seedTime"></div>
        </div>
      </div>
    </div>

    <div class="typing" id="typing"><div class="dots"><span></span><span></span><span></span></div> Nova √©crit‚Ä¶</div>
  </main>

  <div class="inputbar">
    <input id="question" placeholder="√âcris ta question et tape Entr√©e‚Ä¶" autocomplete="off" />
    <button class="btn" id="send">Envoyer</button>
    <button class="btn ghost" id="speakBtn">üîä Lire</button>
    <button class="btn ghost" id="stopBtn">‚èπÔ∏è Stop</button>
    <button class="btn ghost" id="micBtn" title="Reconnaissance vocale">üéôÔ∏è Parler</button>

    <div class="bar2">
      <label>Voix
        <select id="voice"></select>
      </label>
      <label>Vitesse
        <input id="rate" type="range" min="0.7" max="1.4" value="1" step="0.05" />
      </label>
      <label>Volume
        <input id="volume" type="range" min="0" max="1" value="1" step="0.05" />
      </label>
    </div>
  </div>

  <script>
    // ---------- Configuration ----------
    const DEFAULT_API = "https://yarrow-ai-server.vercel.app";
    const API_BASE = () => (localStorage.getItem("API_BASE") || DEFAULT_API).replace(/\/+$/,'');

    // ---------- DOM ----------
    const list = document.getElementById("list");
    const typing = document.getElementById("typing");
    const input = document.getElementById("question");
    const sendBtn = document.getElementById("send");
    const apiInput = document.getElementById("apiUrl");
    const saveApi = document.getElementById("saveApi");
    const voiceSel = document.getElementById("voice");
    const rateInp = document.getElementById("rate");
    const volumeInp = document.getElementById("volume");
    const speakBtn = document.getElementById("speakBtn");
    const stopBtn = document.getElementById("stopBtn");
    const micBtn = document.getElementById("micBtn");

    document.getElementById("seedTime").textContent = new Date().toLocaleTimeString();
    apiInput.value = localStorage.getItem("API_BASE") || DEFAULT_API;

    saveApi.onclick = () => {
      const v = apiInput.value.trim();
      if (v) localStorage.setItem("API_BASE", v);
      else localStorage.removeItem("API_BASE");
      flash(`API = ${API_BASE()}`);
    };

    function flash(msg){
      const row = document.createElement("div");
      row.className = "row nova";
      row.innerHTML = `<div class="avatar">‚ö°</div><div><div class="bubble">${escapeHtml(msg)}</div></div>`;
      list.appendChild(row); list.scrollTop = list.scrollHeight;
    }

    function escapeHtml(s){return s.replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}

    function bubble(me, text){
      const when = new Date().toLocaleTimeString();
      const row = document.createElement("div");
      row.className = "row " + (me ? "me" : "nova");
      row.innerHTML = me
        ? `<div><div class="bubble">${escapeHtml(text)}</div><div class="meta">${when}</div></div><div class="avatar">üßë</div>`
        : `<div class="avatar">N</div><div><div class="bubble">${text}</div><div class="meta">${when}</div></div>`;
      list.appendChild(row);
      list.scrollTop = list.scrollHeight;
    }

    // ---------- Appel backend ----------
    async function askNova(q){
      const question = q ?? input.value.trim();
      if(!question){ input.focus(); return; }

      bubble(true, question);
      input.value = "";
      typing.classList.add("on");

      try{
        const res = await fetch(`${API_BASE()}/api/ask`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question, site: "hydro" })
        });

        const data = await res.json().catch(() => ({}));

        if(res.ok && data && data.ok){
          bubble(false, escapeHtml(data.answer || "Pas de r√©ponse."));
          lastAnswer = data.answer || "";
        }else{
          const msg = (data && (data.error || data.message)) || `HTTP ${res.status}`;
          bubble(false, `‚ùå Erreur : ${escapeHtml(msg)}`);
        }
      }catch(err){
        bubble(false, `‚ùå Erreur de connexion : ${escapeHtml(err.message)}`);
      }finally{
        typing.classList.remove("on");
      }
    }

    sendBtn.addEventListener("click", () => askNova());
    input.addEventListener("keydown", e => {
      if(e.key === "Enter" && !e.shiftKey){ e.preventDefault(); askNova(); }
    });

    // ---------- Synth√®se vocale ----------
    let voices = [];
    let lastAnswer = "";

    function loadVoices(){
      voices = window.speechSynthesis ? speechSynthesis.getVoices() : [];
      voiceSel.innerHTML = "";
      if(!voices.length){
        const opt = document.createElement("option");
        opt.value = ""; opt.textContent = "Voix syst√®me (par d√©faut)";
        voiceSel.appendChild(opt);
        return;
      }
      const preferred = ["fr-CA","fr-FR","fr_FR","fr_CA"];
      voices
        .sort((a,b)=> (a.lang||"").localeCompare(b.lang||""))
        .forEach(v=>{
          const o = document.createElement("option");
          o.value = v.name;
          o.textContent = `${v.name} ‚Äî ${v.lang}`;
          voiceSel.appendChild(o);
          if(preferred.some(p => (v.lang||"").includes(p))) o.selected = true;
        });
    }
    if("speechSynthesis" in window){
      loadVoices();
      if (typeof speechSynthesis.onvoiceschanged !== "undefined"){
        speechSynthesis.onvoiceschanged = loadVoices;
      }
    }

    function speak(text){
      if(!("speechSynthesis" in window)){ flash("Synth√®se vocale non disponible."); return; }
      const t = text || lastAnswer || "";
      if(!t){ flash("Rien √† lire."); return; }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(t);
      const sel = voiceSel.value;
      const v = voices.find(v=>v.name===sel);
      if(v) u.voice = v;
      u.rate = parseFloat(rateInp.value || "1");
      u.volume = parseFloat(volumeInp.value || "1");
      speechSynthesis.speak(u);
    }
    function stopSpeak(){ if("speechSynthesis" in window) speechSynthesis.cancel(); }

    speakBtn.onclick = () => speak();
    stopBtn.onclick = () => stopSpeak();

    // ---------- Micro (Web Speech API) ----------
    let recognizing = false;
    let rec;

    function ensureRecognizer(){
      const Cls = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!Cls){ flash("üé§ Reconnaissance vocale non dispo."); return null; }
      if(rec) return rec;
      rec = new Cls();
      rec.lang = "fr-CA"; 
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      rec.onresult = (e)=>{
        const txt = (e.results[0] && e.results[0][0] && e.results[0][0].transcript) || "";
        if(txt){ input.value = txt; askNova(txt); }
      };
      rec.onerror = (e)=>{ recognizing = false; micBtn.textContent = "üéôÔ∏è Parler"; flash("Micro : " + (e.error||"erreur")); };
      rec.onend = ()=>{ recognizing = false; micBtn.textContent = "üéôÔ∏è Parler"; };
      return rec;
    }

    micBtn.onclick = ()=>{
      const r = ensureRecognizer();
      if(!r) return;
      if(!recognizing){
        try{
          r.start(); recognizing = true; micBtn.textContent = "üõë Stop";
        }catch(e){ flash("Impossible de d√©marrer le micro."); }
      }else{ try{ r.stop(); }catch{} }
    };
  </script>
</body>
</html>
